#!/bin/sh

# Check for confounding variables and prevent the tests from running

scratch=$(mktemp -d -t tmp.XXXXXXXXXX)
function finish {
  rm -rf "$scratch"
}
trap finish EXIT

# 1. Is the system on battery? A low battery has been seen to drop network
#    performance by 50%
ioreg -l > ${scratch}/ioreg
if cat ${scratch}/ioreg | grep ExternalConnected | grep No > /dev/null ; then
  echo System is not connected to an external power supply.
  echo Running on battery can cause some performance metrics to drop by 50%
  exit 1
fi

# 2. Is the system running in a VM? There may be other VMs which we can't
#    see which will compete with us for CPU and I/O throughout
for vendor in VirtualBox Oracle VMware Parallels ; do
  if cat ${scratch}/ioreg | grep -e Manufacturer -e 'Vendor Name' | grep ${vendor} > /dev/null ; then
    echo System is running in a VM under ${vendor}.
    echo There may be other VMs competing with us for CPU and I/O throughput.
    exit 1
  fi
done

# 3. Is the CPU too busy? There may be other processes running which would
#    complete with us for CPU and I/O throughput
avgcpu=$(IFS="\n"; for line in $(top -l 5|grep "CPU usage"); do echo $line | cut -f 7 -d " " | cut -f 1 -d '%'; done | jq -s 'add/length')
idle=$(echo "$avgcpu > 80.0" | bc)
if [ "$idle" -ne 1 ]; then
  echo Average idle CPU over the last 5s is ${avgcpu}.
  echo There may be other process competing with us for CPU.
  exit 1
fi
